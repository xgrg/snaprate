<!DOCTYPE html>
<html lang="en">
    <head>
       <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
       <meta charset="utf-8">
       <meta http-equiv="X-UA-Compatible" content="IE=edge">
       <meta name="viewport" content="width=device-width, initial-scale=1">
       <meta name="description" content="">
       <meta name="author" content="">

       <title>snaprate</title>
       <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
       <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

       <link href="{{static_url("css/jumbotron.css")}}" rel="stylesheet">

    </head>
    <body>

        {{rate_subjects}} <hr>

    <script>

    visible_subject = {{visible_subject}};

    visible_image = 1;
    n_subjects = {{n_subjects}};

    $("img.subject" + visible_subject + "#image1").show();


    function validate(){
      ans = $('input').val();
      if (ans.indexOf('"') > -1){
        alert('Please remove any " from your comments before validating.')
        return false;
      }
      c = get_score();
      console.log(c)
      if (ans != '' && c === ''){
         alert('Please also give a score or remove your comment otherwise.')
         return false;
      }
      else{
        return true;
      }
    }

    function cycle_button(e){
      if ($(this).hasClass("btn-light")) {
          $(this).removeClass("btn-light");
          $(this).addClass("btn-success");
      }
      else if ($(this).hasClass("btn-success")) {
          $(this).removeClass("btn-success");
          $(this).addClass("btn-danger");
      }
      else if ($(this).hasClass("btn-danger")) {
          $(this).removeClass("btn-danger");
          $(this).addClass("btn-warning");
      }
      else if ($(this).hasClass("btn-warning")) {
          $(this).removeClass("btn-warning");
          $(this).addClass("btn-light");
      }
    }

    function color_button(value){
      $("#score").removeClass("btn-success");
      $("#score").removeClass("btn-danger");
      $("#score").removeClass("btn-light");
      $("#score").removeClass("btn-warning");
      if (value == ""){
        $("#score").addClass("btn-light");
      }
      else{
        value = parseInt(value);
        if (value == 1){
          $("#score").addClass("btn-warning");
        }
        else if (value == 0){
          $("#score").addClass("btn-success");
        }
        else if (value == -1){
          $("#score").addClass("btn-danger");
        }
      }
    }
    function color_test(value){
      $("#test").removeClass("btn-success");
      $("#test").removeClass("btn-danger");
      $("#test").removeClass("btn-light");
      if (value == "True"){
        $("#test").addClass("btn-success");
      }
      else if (value == "False"){
        $("#test").addClass("btn-danger");
      }
    }

    function hide_and_show(){
      $("img."+visible_class).hide();
      visible_class = 'subject' + visible_subject;
      visible_image = 1;
      visible_id = 'image' + visible_image;
      $("img."+visible_class+"#image1").show();
      $("span#subject_number").text(visible_subject);
      $("span#image_number").text(visible_image);

    }

    function get_score(){
      if ($("#score").hasClass('btn-light')) {
          return '';
      }
      else if ($("#score").hasClass('btn-danger')) {
          return -1;
      }
      else if ($("#score").hasClass('btn-warning')) {
          return 1;
      }
      else if ($("#score").hasClass('btn-success')) {
          return 0;
      }

    }

    $("a").click(function(e){
      id = $(this).attr('id');
      e.preventDefault();
      if (id == 'xnat'){
         src = $("img.subject"+visible_subject).attr('src')
         $.ajax({
               type: "POST",
               url: "/xnat/",
               data: {"src": src},
               dataType:'json',
               success: function(data) {
                 url = 'https://barcelonabrainimaging.org/data/'
                    + 'experiments/' + data + '?format=html'
                 var win = window.open(url, '_blank');
                 if (win) {
                     win.focus();
                 } else {
                     alert('Please allow popups for this website');
                 }
                 return true;
               },
               error: function(xhr, status, error){
                 console.log(error)
                 console.log(xhr)
                 console.log(status)
               }
             });

      }
      else if (id == "prevsubj") {
        if (validate() == true){
          save_subject("prev");

          visible_class = 'subject' + visible_subject;
          if (visible_subject == 1) {
            visible_subject = n_subjects;
          }
          else {
            visible_subject = visible_subject - 1;
          }

          hide_and_show() //visible_class, visible_subject, visible_image)
        }
      }
      else if (id == "nextsubj"){
        if (validate() == true){
          save_subject("next");

          visible_class = 'subject' + visible_subject;
          if (visible_subject == n_subjects) {
            visible_subject = 1;
          }
          else {
            visible_subject = visible_subject + 1;
          }

          hide_and_show() ; //visible_class, visible_subject, visible_image)
        }
      }
      else if (id == 'nextbad'){
        if (validate() == true){
           save_subject("nextbad");
        }
      }
      return false;
    });

    $.urlParam = function(name){
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results==null){
           return null;
        }
        else{
           return results[1] || 0;
        }
    }

    function save_subject(then){
      s = $.urlParam('s')
      if (s==null){
        s = 'ASHS'
      }

      $.ajax({
            type: "POST",
            url: "/post/",
            data: {"score": get_score(),
                   "comments": $('input').val(),
                   "subject":visible_subject,
                   "pipeline":s,
                   "then":then},
            dataType:'json',
            success: function(data) {
                if ($('#score').hasClass('btn-light')){
                    $( "span.skipped" ).fadeIn( 150 ).delay( 100 ).fadeOut( 300 );
                }
                else {
                  $( "span.success" ).fadeIn( 150 ).delay( 100 ).fadeOut( 300 );
                }
                color_button(data[0]);
                $('input').val(data[1]);
                $('#username').text(data[2]);
                if (then == 'nextbad'){
                  visible_class = 'subject' + visible_subject;
                  visible_subject = parseInt(data[3]);
                  hide_and_show()
                }
                if (data.length > 4){
                  color_test(data[4]);
                  for (i = 0 ; i < data[5].length ; i++){
                    $('#test'+i).text(data[5][i][0]+': ' + data[5][i][1])
                  }
                }
                return data;

            }
        });
    }
    $('a#logout').unbind('click')
    $('a#download').unbind('click')
    //$("span").click(save_subject);
    $("#score").click(cycle_button);


    </script>
  </body>
</html>
