<!DOCTYPE html>



<html lang="en">

<head>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="{{static_url("js/pace.min.js")}}"></script>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>snaprate</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/d3js/3.5.9/d3.min.js"></script>

  <link href="{{static_url("css/jumbotron.css")}}" rel="stylesheet">
  <script src="{{static_url("js/utils.js")}}"></script>
  <script src="{{static_url("js/buttons.js")}}"></script>
  <script src="{{static_url("js/polygon.js")}}"></script>



</head>

<body>

  <svg></svg>

  {{rate_subjects}}
  <hr>

  <script>
  {{images}}

  index = {{index}};
  n_subjects = {{n_subjects}};
  polygons = JSON.parse("{{polygons}}");
  console.log(polygons)


  // Handling buttons (buttons.js)
  $("a").click(function(e){
  id = $(this).attr('id');
  e.preventDefault();

  if (id == "prevsubj") {
  onclick_prev();
  }
  else if (id == "nextsubj"){
  onclick_next();
  }
  return false;
  });

  $('a#logout').unbind('click')
  $('a#stats').unbind('click')
  $('a#download').unbind('click')
  $("#score").click(cycle_button);


  // Handling keys
  document.onkeydown = function(e) {
  e = e || window.event;
  if (e.ctrlKey && e.which == 83) {
  e.preventDefault();
  window.location.href = "download/?s=" + $.urlParam('s');
  }
  else if (e.which == 32 && !$("input.form-control").is(':focus')){
  e.preventDefault();
  cycle_button();
  }
  else if (e.which == 39 && !$("input.form-control").is(':focus')){
  e.preventDefault();
  onclick_next();
  }
  else if (e.which == 37 && !$("input.form-control").is(':focus')){
  e.preventDefault();
  onclick_prev();
  }
  };
  showImage();

  </script>

</body>
<script>
  var svg = d3.select('svg')
    .attr('height', 1000)
    .attr('width', 1000);

  var myimage = svg.append('image')
    .attr('xlink:href', '{{jf}}')
    .attr('width', 1000)
    .attr('height', 1000)

  var dragging = false,
    drawing = false,
    startPoint;

  var points = [],
    g;
  // behaviors
  var dragger = d3.behavior.drag()
    .on('drag', handleDrag)
    .on('dragend', function(d) {
      dragging = false;
    });
  svg.on('mouseup', function() {
    if (dragging) return;
    drawing = true;
    startPoint = [d3.mouse(this)[0], d3.mouse(this)[1]];
    if (svg.select('g.drawPoly').empty()) g = svg.append('g').attr('class', 'drawPoly');
    if (d3.event.target.hasAttribute('is-handle')) {
      closePolygon();
      return;
    };
    points.push(d3.mouse(this));
    g.select('polyline').remove();
    var polyline = g.append('polyline').attr('points', points)
      .style('fill', 'none')
      .attr('stroke', '#000');
    for (var i = 0; i < points.length; i++) {
      g.append('circle')
        .attr('cx', points[i][0])
        .attr('cy', points[i][1])
        .attr('r', 4)
        .attr('fill', 'yellow')
        .attr('stroke', '#000')
        .attr('is-handle', 'true')
        .style({
          cursor: 'pointer'
        });
    }
  });
  svg.on('mousemove', function() {
    if (!drawing) return;
    var g = d3.select('g.drawPoly');
    g.select('line').remove();
    var line = g.append('line')
      .attr('x1', startPoint[0])
      .attr('y1', startPoint[1])
      .attr('x2', d3.mouse(this)[0] + 2)
      .attr('y2', d3.mouse(this)[1])
      .attr('stroke', '#53DBF3')
      .attr('stroke-width', 1);
  })

  drawPoly(polygons);
</script>

</html>
